---
import { Image } from "astro:assets";

interface Props {
  images: ImageMetadata[];
  alt?: string;
}

const { images, alt = "Gallery image" } = Astro.props;
const id = `lightbox-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="lightbox-gallery">
  {images.map((image, index) => (
    <button
      class="lightbox-thumbnail"
      data-lightbox={id}
      data-index={index}
      type="button"
    >
      <Image
        src={image}
        alt={`${alt} ${index + 1}`}
        width={400}
        height={300}
        loading="lazy"
        quality={80}
      />
    </button>
  ))}
</div>

<dialog id={id} class="lightbox-dialog">
  <div class="lightbox-content">
    <button class="lightbox-close" aria-label="Close">&times;</button>

    <button class="lightbox-prev" aria-label="Previous">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div class="lightbox-image-container">
      {images.map((image, index) => (
        <div class="lightbox-slide" data-slide={index} style={index === 0 ? '' : 'display: none;'}>
          <Image
            src={image}
            alt={`${alt} ${index + 1}`}
            width={1600}
            height={1200}
            quality={95}
          />
        </div>
      ))}
    </div>

    <button class="lightbox-next" aria-label="Next">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>

    <div class="lightbox-counter">
      <span class="lightbox-current">1</span> / <span class="lightbox-total">{images.length}</span>
    </div>
  </div>
</dialog>

<script define:vars={{ id }}>
  const dialog = document.getElementById(id);
  const slides = dialog.querySelectorAll('.lightbox-slide');
  const counter = dialog.querySelector('.lightbox-current');
  let currentIndex = 0;

  function showSlide(index) {
    slides.forEach((slide, i) => {
      slide.style.display = i === index ? 'block' : 'none';
    });
    currentIndex = index;
    counter.textContent = index + 1;
  }

  function nextSlide() {
    showSlide((currentIndex + 1) % slides.length);
  }

  function prevSlide() {
    showSlide((currentIndex - 1 + slides.length) % slides.length);
  }

  // Open lightbox
  document.querySelectorAll(`[data-lightbox="${id}"]`).forEach(btn => {
    btn.addEventListener('click', () => {
      const index = parseInt(btn.dataset.index);
      showSlide(index);
      dialog.showModal();
    });
  });

  // Close button
  dialog.querySelector('.lightbox-close').addEventListener('click', () => {
    dialog.close();
  });

  // Navigation buttons
  dialog.querySelector('.lightbox-next').addEventListener('click', nextSlide);
  dialog.querySelector('.lightbox-prev').addEventListener('click', prevSlide);

  // Keyboard navigation
  dialog.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') nextSlide();
    if (e.key === 'ArrowLeft') prevSlide();
  });

  // Click backdrop to close
  dialog.addEventListener('click', (e) => {
    if (e.target === dialog) dialog.close();
  });
</script>

<style lang="scss">
  .lightbox-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
    gap: 1rem;
    margin: 2rem 0;
  }

  .lightbox-thumbnail {
    border: none;
    padding: 0;
    cursor: pointer;
    overflow: hidden;
    border-radius: 8px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    background: none;

    &:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  }

  .lightbox-dialog {
    border: none;
    padding: 0;
    max-width: 100vw;
    max-height: 100vh;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    color: white;

    &::backdrop {
      background: rgba(0, 0, 0, 0.9);
    }
  }

  .lightbox-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image-container {
    max-width: 90vw;
    max-height: 95vh;
    display: flex;
    align-items: center;
    justify-content: center;

    img {
      max-width: 100%;
      max-height: 95vh;
      width: auto;
      height: auto;
      object-fit: contain;
    }
  }

  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
    z-index: 10;

    &:hover {
      background: rgba(255, 255, 255, 0.2);
    }
  }

  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
    z-index: 10;

    &:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    svg {
      display: block;
    }
  }

  .lightbox-prev {
    left: 1rem;
  }

  .lightbox-next {
    right: 1rem;
  }

  .lightbox-counter {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.5);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .lightbox-prev,
    .lightbox-next {
      width: 40px;
      height: 40px;
    }

    .lightbox-close {
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
    }
  }
</style>
